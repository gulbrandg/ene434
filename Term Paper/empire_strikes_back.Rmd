---
title: "a_new_hope"
author: "Gulbrand Galaasen"
date: "2024-05-09"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(zoo)
library(lubridate)
library(janitor)
library(hablar)
library(tsibble)
library(fpp3)
library(tseries)
```

examining drivers for cross border power exchange in the Norwegian power market and forecast of future developments under different scenarios.

"What are the key drivers influencing cross-border power exchanges from UK and continental Europe in the Norwegian power market, and how can these influences be projected into future scenarios?"

## Introduction

Purpose: Start by introducing the topic and stating the purpose of the research. Explain the significance of cross-border power exchanges for the Norwegian power market, focusing on economic, environmental, and energy security aspects.
Research Question: Clearly state the refined research question.
Scope: Outline the scope of the analysis, including the geographical focus, the time frame considered for historical data analysis, and the future scenarios to be examined.
Structure of the Paper: Briefly describe the structure of the paper, outlining what each subsequent section will cover.


```{r}
# Where our data ends
CUT_OFF <- "2024-05-01"

# The areas/connections-to we study
areas <- c("DE", "DK", "NL", "UK")

# Bidding zones for Norwegian day-ahead electricity prices
Bidding_zone <- c("NO1", "NO2", "NO3", "NO4", "NO5")

# Dates for when connections were fully operational
DE_conn <- "2021-05-27"
UK_conn <- "2021-10-01"


```


```{r, warning=FALSE}
dayAheadPrices <- function(Bidding_zone, year) {
  read_csv(paste0("data/Norwegian_Day_Ahead_prices/DA_price_", Bidding_zone, "_", year, ".csv"),show_col_types = FALSE) %>% 
    .[,c(1,2,3)] %>% 
     `colnames<-`(c("date", "Price", "Currency")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(Price = as.double(Price),
           Bidding_zone = Bidding_zone,
           Unit = "[EUR / MWh]") %>%
    group_by(date) %>%
    filter(date < as.Date(CUT_OFF)) %>%
    summarise(Price = mean(Price), Bidding_zone = unique(Bidding_zone), unique(Unit))
}

# dayAheadPrices("NO1", 2018) %>% 
#   print()

gather_dayAheadPrices <- function(Bidding_zone) {
  map2(rep(Bidding_zone, 7), c("2018":"2024"), dayAheadPrices) %>% 
    bind_rows()
}



```




```{r}
# Exchange
cross_border_flow <- function(area, year) {
  read_csv(paste0("data/exchange/", area, "_", year, ".csv"),show_col_types = FALSE) %>% 
    .[,c(1,2,3)] %>% 
     `colnames<-`(c("date", "import", "export")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(import = as.double(import),
           export = as.double(export)) %>% 
    group_by(date) %>%
    summarize(exchange = sum(import, na.rm = TRUE) - sum(export, na.rm = TRUE)) %>% 
    mutate(area = area) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_cross_flow <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), cross_border_flow) %>% 
    bind_rows()
}

# Consumption
gather_load <- function(area, year) {
  read_csv(paste0("data/load_", area, "/load_", area, "_", year, ".csv")) %>% 
    .[,c(1,3)] %>% 
    `colnames<-`(c("date", "load")) %>% 
    drop_na() %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(load = as.double(load)) %>%
    group_by(date) %>% 
    summarize(load = sum(load)) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_load_area <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), gather_load) %>% 
    bind_rows() %>%  
    mutate(area = area)
}

# Generation
gather_generation <- function(area, year) {
  if (area == "NO") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv"), na = c("n/e", "N/A", "-")) %>% 
      .[,2:23] %>% 
      mutate(gen = rowSums(.[,2:22], na.rm = TRUE)) %>% 
      select(MTU, gen) %>% 
      rename(date = MTU) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>% 
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      group_by(date) %>% 
      summarize(gen = sum(gen)) %>% 
      filter(date < as.Date(CUT_OFF))
      
  } else {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv")) %>% 
      .[,c(2,20,22,23)] %>% 
      `colnames<-`(c("date", "sol", "wnd_off", "wnd_on")) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>% 
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      mutate(vrep = as.double(sol) + as.double(wnd_off) + as.double(wnd_on)) %>%
      group_by(date) %>% 
      summarize(vrep = sum(vrep)) %>% 
      filter(date < as.Date(CUT_OFF))
  }
}

gather_generation_area <- function(area) {
  # Special case for UK data as these are not present in Etsoe because of Brexit
  if (area == "UK") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, ".csv")) %>% 
      .[,c(3,6,7)] %>% 
      `colnames<-`(c("date", "type", "vrep")) %>%
      filter(type %in% c("WIND")) %>% 
      mutate(date = as.Date(with_tz(date, tzone = "Europe/Oslo"), tz = "Europe/Oslo")) %>% 
      group_by(date) %>%
      summarize(vrep = sum(as.double(vrep), na.rm = TRUE)) %>% 
      arrange(date) %>% 
      filter(date < as.Date(CUT_OFF)) %>% 
      mutate(area = area)
      
  } else {
    map2(rep(area, 7), c("2018":"2024"), gather_generation) %>% 
      bind_rows() %>%  
      mutate(area = area) 
  }
}
```

```{r, warning=FALSE, message=FALSE}
# Gather data

# Prices
Prices <- map(Bidding_zone, gather_dayAheadPrices) %>%
  bind_rows()

mean_prices_all_bidding_zones <- Prices %>% 
  group_by(date) %>% 
  summarise(mean_price_NO_all = mean(Price)) %>% 
  mutate(Unit = "[EUR / MWh]")

# Exchange
exchange <- map(areas, gather_cross_flow) %>%
  bind_rows()

# Consumption
load_NO <- gather_load_area("NO")

# Generation
gen_NO <- gather_generation_area("NO")

# Variable renewable production
vrep <- map(areas, gather_generation_area) %>% 
  bind_rows()
```

```{r}
df <- exchange %>% 
  inner_join(., vrep, by = c("date", "area")) %>% 
  inner_join(., gen_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., load_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., mean_prices_all_bidding_zones[c(1,2)], by = c("date"))
```



```{r}
df %>% 
  filter(area == "DE") %>% 
  filter(exchange != 0) %>% 
  #filter(date >= as.Date("2020-12-09")) %>% 
  ggplot(aes(x = load, y = exchange, color = date)) +
  geom_point() +
  geom_smooth(method = "lm")
```
```{r, warning=FALSE}

Facet_gen <- df %>% 
  select(date, exchange, area, gen) %>% 
  ggplot(aes(x = gen, y = exchange, color = date)) +
  geom_point() +
  facet_wrap(~ area, scales = 'free_y')+
  geom_smooth(method = "lm") +
  labs(title = "Title XXXX", x = "Generation", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Facet_vrep <- df %>% 
  select(date, exchange, area, vrep) %>% 
  ggplot(aes(x = vrep, y = exchange, color = date)) +
  geom_point() +
  facet_wrap(~ area, scales = 'free')+
  geom_smooth(method = "lm") +
  labs(title = "Title XXXX", x = "VRE", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Facet_load <- df %>% 
  select(date, exchange, area, load) %>% 
  ggplot(aes(x = load, y = exchange, color = date)) +
  geom_point() +
  facet_wrap(~ area, scales = 'free')+
  geom_smooth(method = "lm") +
  labs(title = "Title XXXX", x = "Load", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))


Facet_gen
Facet_vrep
Facet_load

```



```{r}
df %>% 
  ggplot(aes(x = date, y = vrep, color = area)) + 
  geom_line()
```

