---
title: "a_new_hope"
author: "Gulbrand Galaasen"
date: "2024-05-09"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(zoo)
library(lubridate)
library(janitor)
library(hablar)
library(tsibble)
library(fpp3)
library(tseries)
```

```{r}
CUT_OFF <- "2024-05-01"
areas <- c("DE", "DK", "NL", "UK")
```

Load

```{r, warning=FALSE, message=FALSE}
# Load
gather_load <- function(area, year) {
  read_csv(paste0("load_", area, "/load_", area, "_", year, ".csv")) %>% 
    .[,c(1,3)] %>% 
    `colnames<-`(c("date", "load")) %>% 
    drop_na() %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(load = as.double(load)) %>%
    group_by(date) %>% 
    summarize(load = sum(load)) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_load_area <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), gather_load) %>% 
    bind_rows() %>%  
    mutate(area = area)
}

df <- gather_load_area("NO")

```

```{r}
df %>% 
  ggplot(aes(x = date, y = load)) +
  geom_line()
```


Generation data.

```{r, warning=FALSE, message=FALSE}
# Generation
gather_generation <- function(area, year) {
  read_csv(paste0("gen_", area, "/gen_", area, "_", year, ".csv")) %>% 
    .[,c(2,20,22,23)] %>% 
    `colnames<-`(c("date", "sol", "wnd_off", "wnd_on")) %>% 
    drop_na() %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(vrep = as.double(sol) + as.double(wnd_off) + as.double(wnd_on)) %>%
    group_by(date) %>% 
    summarize(vrep = sum(vrep)) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_generation_area <- function(area) {
  # Special case for UK data as these are not present in Etsoe because of Brexit
  if (area == "UK") {
    read_csv(paste0("gen_", area, "/gen_", area, ".csv")) %>% 
      .[,c(3,6,7)] %>% 
      `colnames<-`(c("date", "type", "vrep")) %>%
      filter(type %in% c("WIND")) %>% 
      mutate(date = as.Date(with_tz(date, tzone = "Europe/Oslo"), tz = "Europe/Oslo")) %>% 
      group_by(date) %>%
      summarize(vrep = sum(as.double(vrep), na.rm = TRUE)) %>% 
      arrange(date) %>% 
      filter(date < as.Date(CUT_OFF)) %>% 
      mutate(area = area)
      
  } else {
    map2(rep(area, 7), c("2018":"2024"), gather_generation) %>% 
      bind_rows() %>%  
      mutate(area = area) 
  }
}

df <- map(areas, gather_generation_area) %>% 
  bind_rows()
```

```{r}
df %>% 
  ggplot(aes(x = date, y = vrep, color = area)) + 
  geom_line()
```

