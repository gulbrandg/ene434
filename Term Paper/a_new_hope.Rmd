---
title: "a_new_hope"
author: "Gulbrand Galaasen"
date: "2024-05-09"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Introduction
The European energy landscape is undergoing a significant transformation towards sustainable solutions, propelled by increasing demands for renewable resources and enhanced concerns regarding energy security. This shift has affected the power market dynamics in Norway due to the market coupling and transmission interconnections with Europe. The market coupling and interconnections facilitate the exchange of power to and from Norway, thereby enhancing grid stability, bolstering regional energy security, and ensuring the socially optimum allocation of scarce resources.

Impact of Geopolitical Events
The recent energy crisis, exacerbated by geopolitical conflicts such as the Russian invasion of Ukraine in early 2022, has underscored the fragility of European energy supplies. This event led to a significant reduction in the supply of natural gas, a pivotal energy source for many European countries, thereby accelerating investment in variable renewable energy (VRE) sources such as wind and solar power. As the proportion of VRE in the energy mix increases, power prices have experienced marked volatility, primarily driven by the variability in supply-demand dynamics and the constraints of transmission capacities. 

Market Mechanisms and Pricing
In Norway, the hourly spot price for wholesale electricity in each bidding zone is established a day in advance in the day-ahead market. The optimization algorithm EUPHEMIA plays a critical role in this process by calculating the hourly system and zonal spot prices implicitly by the optimal power flow and dispatch of power plants based on the aggregated supply- and demand bids from market participants. The system spot price signals the theoretical price with no transmission constraints, while zonal prices result from congestion management between price areas, constrained by their inter-zonal transmission capacity, to signal scarcity. Adjustments to discrepancies in supply and demand are subsequently addressed in the intraday market and through ancillary services provided by Transmission System Operators (TSOs).

Norwegian Market Dynamics
In Norway, the energy mix consists primarily of dispatchable hydropower plants with low marginal costs, of which the export of power generally correlates with the importation of higher prices from other European markets. Conversely, power import correlates with low precipitation and abundant wind-generated electricity in northern Europe, produced at near-zero marginal costs, which tends to decrease Norwegian power prices. However, in periods of low water values, and renewables cannot meet demand, prices tend to increase as more expensive, dispatchable fossil-fueled generation is required to cover the shortfall.

Consumer Impact and Future Outlook
In recent years, these market dynamics have led to an incremental increase in energy costs for Norwegian consumers. Meanwhile, power producers benefit from enhanced market coupling as profit margins proportionately increase as wholesale electricity prices surge. With intensifying global efforts to phase out fossil fuels, the demand for renewable energy in Europe is expected to continue its upward trajectory. The future pricing landscape for electricity will likely be influenced by the marginal costs of available energy technologies needed to satisfy demand, coupled with the cross-border exchange capacities necessary to transport electricity effectively. As a result, investments in onshore and offshore wind power are increasing, and market mechanisms indicate that an increase in the capacity of wind power plants will positively affect power prices, assuming other variables remain constant. Nonetheless, the complex interdependencies introduced by cross-border energy trading, combined with the variability of renewable energy generation, highlight the challenges in forecasting future electricity prices accurately.

Research question:

What are the drivers for over seas exchange from Norway, and how will the future exchange look taking into account different fundamental changes in Norwegian generation and consumption, and variable renewable energy in northern continental Europe and UK.


```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(zoo)
library(lubridate)
library(janitor)
library(hablar)
library(tsibble)
library(fpp3)
library(tseries)
library(forecast)
library(pander)
```

```{r}
# Where our data ends
CUT_OFF <- "2024-05-01"

# The areas/connections-to we study
areas <- c("DE", "DK", "NL", "UK")

# Bidding zones for Norwegian day-ahead electricity prices
Bidding_zone <- c("NO1", "NO2", "NO3", "NO4", "NO5")

# Dates for when connections were fully operational
DE_conn <- "2021-01-01"
UK_conn <- "2021-10-01"
```



```{r}
# Prices
dayAheadPrices <- function(Bidding_zone, year) {
  read_csv(paste0("data/Norwegian_Day_Ahead_prices/DA_price_", Bidding_zone, "_", year, ".csv"),show_col_types = FALSE) %>% 
    .[,c(1,2)] %>% 
     `colnames<-`(c("date", "price")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(price = as.double(price),
           Bidding_zone = Bidding_zone) %>%
    group_by(date) %>%
    filter(date < as.Date(CUT_OFF)) %>%
    summarise(price = mean(price, na.rm = TRUE), Bidding_zone = unique(Bidding_zone))
}

gather_dayAheadPrices <- function(Bidding_zone) {
  map2(rep(Bidding_zone, 7), c("2018":"2024"), dayAheadPrices) %>% 
    bind_rows()
}


# Exchange
cross_border_flow <- function(area, year) {
  read_csv(paste0("data/exchange/", area, "_", year, ".csv"), show_col_types = FALSE) %>% 
    .[,c(1,2,3)] %>% 
     `colnames<-`(c("date", "import", "export")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(import = as.double(import, na.rm = TRUE),
           export = as.double(export, na.rm = TRUE)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    group_by(date) %>%
    summarize(exchange = mean(import, na.rm = TRUE) - mean(export, na.rm = TRUE)) %>% 
    mutate(area = area) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_cross_flow <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), cross_border_flow) %>% 
    bind_rows()
}


# Consumption
gather_load <- function(area, year) {
  read_csv(paste0("data/load_", area, "/load_", area, "_", year, ".csv")) %>% 
    .[,c(1,3)] %>% 
    `colnames<-`(c("date", "load")) %>% 
    drop_na() %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(load = as.double(load)) %>%
    group_by(date) %>% 
    summarize(load = mean(load)) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_load_area <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), gather_load) %>% 
    bind_rows() %>%  
    mutate(area = area)
}

# Generation
gather_generation <- function(area, year) {
  if (area == "NO") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv"), na = c("n/e", "N/A", "-")) %>% 
      .[,2:23] %>% 
      mutate(gen = rowSums(.[,2:22], na.rm = TRUE)) %>% 
      select(MTU, gen) %>% 
      rename(date = MTU) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>%
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      group_by(date) %>% 
      summarize(gen = mean(gen)) %>% 
      filter(date < as.Date(CUT_OFF))
      
  } else {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv")) %>% 
      .[,c(2,20,22,23)] %>% 
      `colnames<-`(c("date", "sol", "wnd_off", "wnd_on")) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>% 
      mutate(vrep = as.double(sol) + as.double(wnd_off) + as.double(wnd_on)) %>%
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      group_by(date) %>% 
      summarize(vrep = mean(vrep)) %>% 
      filter(date < as.Date(CUT_OFF))
  }
}

gather_generation_area <- function(area) {
  # Special case for UK data as these are not present in Etsoe because of Brexit
  if (area == "UK") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, ".csv")) %>% 
      .[,c(3,6,7)] %>% 
      `colnames<-`(c("date", "type", "vrep")) %>%
      filter(type %in% c("WIND")) %>% 
      mutate(vrep = as.double(vrep)) %>% 
      mutate(date = as.Date(with_tz(date, tzone = "Europe/Oslo"), tz = "Europe/Oslo")) %>% 
      group_by(date) %>%
      summarize(vrep = mean(vrep, na.rm = TRUE)) %>% 
      arrange(date) %>% 
      filter(date < as.Date(CUT_OFF)) %>% 
      mutate(area = area)
      
  } else {
    map2(rep(area, 7), c("2018":"2024"), gather_generation) %>% 
      bind_rows() %>%  
      mutate(area = area) 
  }
}
```

```{r, warning=FALSE, message=FALSE}
# Gather data

# Prices
price <- map(Bidding_zone, gather_dayAheadPrices) %>%
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(price = mean(price, na.rm = TRUE))

# Exchange
exchange <- map(areas, gather_cross_flow) %>%
  bind_rows()

# Consumption
load_NO <- gather_load_area("NO")

# Generation
gen_NO <- gather_generation_area("NO")

# Variable renewable production
vrep <- map(areas, gather_generation_area) %>% 
  bind_rows()
```

```{r}
df <- exchange %>% 
  inner_join(., vrep, by = c("date", "area")) %>% 
  inner_join(., gen_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., load_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., price[,c(1,2)], by = c("date"))

is.nan.data.frame <- function(x)
do.call(cbind, lapply(x, is.nan))
df[is.nan(df)] <- 0
```

What drives exchange?

```{r, warning = FALSE, message = FALSE}
Facet_gen <- df %>% 
  select(date, exchange, area, gen) %>% 
  filter(exchange != 0) %>% 
  ggplot(aes(x = gen, y = exchange, color = date)) +
  geom_point() +
  facet_wrap(~ area, scales = 'free_y')+
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Title XXXX", x = "Generation", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Facet_vrep <- df %>% 
  select(date, exchange, area, vrep) %>% 
  filter(exchange != 0) %>% 
  ggplot(aes(x = vrep, y = exchange, color = date)) +
  geom_point() +
  facet_wrap(~ area, scales = 'free')+
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Title XXXX", x = "VREP", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Facet_load <- df %>% 
  select(date, exchange, area, load) %>% 
  filter(exchange != 0) %>% 
  ggplot(aes(x = load, y = exchange, color = date)) +
  geom_point() +
  facet_wrap(~ area, scales = 'free')+
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Title XXXX", x = "Load", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))


Facet_gen
Facet_vrep
Facet_load

```

Da

```{r}
get_coeff_gen <- function(a) {
  df %>% 
    select(date, exchange, area, gen) %>% 
    filter(exchange != 0) %>% 
    filter(area == a) %>% 
    lm(data = ., formula = exchange ~ gen) %>% 
    summary(.) %>% 
    .$coefficients %>% 
    as_tibble() %>% 
    .[2,c("Estimate", "Pr(>|t|)")] %>%
    `colnames<-`(c("coeff", "p_value")) %>% 
    mutate(p_value = ifelse(p_value > 0.1, "-", 
                     ifelse(p_value > 0.05, "*", 
                     ifelse(p_value > 0.01, "**", "***")))) %>% 
    mutate(coeff = paste0(round(coeff, 3), " ", p_value)) %>% 
    .$coeff
}

get_coeff_vrep <- function(a) {
  df %>% 
    select(date, exchange, area, vrep) %>% 
    filter(exchange != 0) %>% 
    filter(area == a) %>% 
    lm(data = ., formula = exchange ~ vrep) %>% 
    summary(.) %>% 
    .$coefficients %>% 
    as_tibble() %>% 
    .[2,c("Estimate", "Pr(>|t|)")] %>%
    `colnames<-`(c("coeff", "p_value")) %>% 
    mutate(p_value = ifelse(p_value > 0.1, "-", 
                     ifelse(p_value > 0.05, "*", 
                     ifelse(p_value > 0.01, "**", "***")))) %>% 
    mutate(coeff = paste0(round(coeff, 3), " ", p_value)) %>% 
    .$coeff
}

get_coeff_load <- function(a) {
  df %>% 
    select(date, exchange, area, load) %>% 
    filter(exchange != 0) %>% 
    filter(area == a) %>% 
    lm(data = ., formula = exchange ~ load) %>% 
    summary(.) %>% 
    .$coefficients %>% 
    as_tibble() %>% 
    .[2,c("Estimate", "Pr(>|t|)")] %>%
    `colnames<-`(c("coeff", "p_value")) %>% 
    mutate(p_value = ifelse(p_value > 0.1, "-", 
                     ifelse(p_value > 0.05, "*", 
                     ifelse(p_value > 0.01, "**", "***")))) %>% 
    mutate(coeff = paste0(round(coeff, 3), " ", p_value)) %>% 
    .$coeff
}

tibble(area = areas) %>% 
  mutate(gen = unlist(map(areas, get_coeff_gen)),
         vrep = unlist(map(areas, get_coeff_vrep)),
         load = unlist(map(areas, get_coeff_load)))
```



```{r}
res <- map(c("SE", "FI"), gather_cross_flow) %>%
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(exchange = sum(exchange))

df %>% 
  #filter(area != "DE") %>% 
  group_by(date) %>% 
  summarise(exchange = sum(exchange),
            gen = first(gen),
            load = first(load)) %>% 
  mutate(exchange = exchange + res$exchange,
         tot = gen + exchange - load) %>% 
  ggplot() +
  geom_line(aes(x = date, y = tot, color = "tot")) +
  geom_line(aes(x = date, y = load, color = "load")) + 
  geom_line(aes(x = date, y = exchange, color = "exchange"))
```


Forecast exchange

```{r}
cap <- tibble(area = c("DE", "DK", "NL", "UK"),
              import_cap = c(1425, 1639, 730, 1330),
              export_cap = c(-1407, -1658, -706, -1450),
              from_date = c("2021-01-01", "2021-01-01", "2023-01-01", "2022-01-01"))

DATE_RANGE <- seq(as.Date(CUT_OFF), as.Date("2029-12-31"), by = "day")

N_DAYS <- 

```

Firstly, we need to synthesize variable renewable production (VREP) in our data. This is done by taking data from 2023 and creating a pool of values for each month and area. Then for a single date, a future value is drawn from this pool given a month and area, and is then multiplied by a random factor [0.9, 1.1] to essentially simulate the uncertainty of wind and solar for a given day.  

```{r}
# Synthesize vrep
vrep_area_month <-
  df %>% 
  filter(date >= as.Date("2023-01-01")) %>% 
  filter(date < as.Date("2024-01-01")) %>% 
  mutate(month = month(date)) %>% 
  select(month, area, vrep)

draw_vrep <- function(a, m) {
  vrep_area_month %>%
    filter(area == a) %>% 
    filter(month == m) %>% 
    .$vrep %>% 
    sample(1, replace = TRUE) * runif(1, min = 0.9, max = 1.1)
} 
```

We also need to synthesize the future co 

```{r}
load_data <- df %>% 
  group_by(date) %>% 
  summarise(load = first(load)) %>% 
  tsibble(index = date) 

load_model <- 
  load_data %>% 
  model(mod = ARIMA(load ~ pdq(3,0,1) + PDQ(0,0,0) +
                      fourier(period = 365, K = 10) +
                      fourier(period = 7, K = 3)
                    )
  )

load_model %>% report()
load_model %>% gg_tsresiduals()

load_model %>% 
  forecast(h = 1000) %>% 
  autoplot(load_data)
```



```{r}

create_dataset_area <- function(a, from, s) {
  old_df <-
    df %>% 
    filter(area == a) %>% 
    filter(date >= as.Date(from)) %>% 
    select(date, area, exchange, vrep)
  
  new_df <- 
    tibble(date = seq(as.Date(CUT_OFF), as.Date("2025-12-31"), by = "day"),
           area = a,
           exchange = NA,
           vrep = unlist(map2(a, month(date), draw_vrep)) * s)  

  return(
    rbind(old_df, new_df) %>% 
      tsibble(index = date) 
  )
} 

```


```{r}

forecast_exchange <- function(a, vrep_coeff) {
  import_cap <- cap %>% 
    filter(area == a) %>% 
    .$import_cap
  
  export_cap <- cap %>% 
    filter(area == a) %>% 
    .$export_cap
  
  from_date <- cap %>% 
    filter(area == a) %>% 
    .$from_date
  
  data <- create_dataset_area(a, from_date, vrep_coeff)
  
  data_fit <- data %>% 
    filter(date < as.Date(CUT_OFF))
  
  data_pred <- data %>% 
    filter(date >= as.Date(CUT_OFF))
  

  model <- 
    data_fit %>% 
    fill_gaps() %>%
    model(mod = ARIMA(exchange ~ vrep))
  
  model %>% 
    gg_tsresiduals() %>% 
    print()
  
  pred <- 
    model %>% 
    forecast(., new_data = data_pred) %>% 
    mutate(.mean = unlist(map2(.mean, rep(import_cap, 610), min))) %>% 
    mutate(.mean = unlist(map2(.mean, rep(export_cap, 610), max))) 
    
  pred %>% autoplot(data_fit) %>% 
    print()
  
  return(
    pred %>% 
      as_tibble()
    )
}

scen1 <- map2(areas, 1, forecast_exchange) %>% 
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(exchange = sum(.mean))

scen2 <- map2(areas, 1.25, forecast_exchange) %>% 
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(exchange = sum(.mean))

scen3 <- map2(areas, 1.5, forecast_exchange) %>% 
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(exchange = sum(.mean))
```
Price forecast

```{r}
pdf <- df %>% 
  group_by(date) %>% 
  summarise(price = first(price),
            exchange = sum(exchange),
            load = first(load)) %>% 
  filter(date >= as.Date("2023-01-01")) %>% 
  tsibble(index = date) #%>% 
  #mutate(price = difference(price),
  #       exchange = difference(exchange),
  #       load = difference(load))
  

load_profile <- pdf %>% 
  filter(date >= as.Date("2022-05-01")) %>% 
  filter(date < as.Date("2024-01-01")) %>% 
  select(date, load)

future <- 
  tibble(date = seq(as.Date(CUT_OFF), as.Date("2025-12-31"), by = "day"),
         price = NA,
         scen1 = scen1$exchange,
         scen2 = scen2$exchange,
         scen3 = scen3$exchange,
         load = load_profile$load) %>% 
  tsibble(index = date)
```

```{r}
model <- 
  pdf %>% 
  fill_gaps() %>%
  model(mod = ARIMA(price ~ 0 + exchange + load))

model %>% 
  report()

model %>% 
  gg_tsresiduals()

pred1 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = scen1))) 

pred2 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = scen2))) 

pred3 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = scen3))) 
  
pred1 %>% autoplot(pdf) 

pred2 %>% autoplot(pdf)

pred3 %>% autoplot(pdf)

pred1 %>% 
  ggplot() +
  geom_line(aes(x = date, y = .mean, color = "vrep_coeff = 1")) +
  geom_line(aes(x = date, y = pred2$.mean, color = "vrep_coeff = 1.25")) +
  geom_line(aes(x = date, y = pred3$.mean, color = "vrep_coeff = 1.5"))

mean(pred1$.mean)
mean((pred1$.mean - pred2$.mean) / pred1$.mean) * 100
mean((pred1$.mean - pred3$.mean) / pred1$.mean) * 100
```


```{r}
adf.test(difference(pdf$load)[2:length(difference(pdf$load))])



unitroot_ndiffs(pdf$load)


pdf %>% 
  ggplot() +
  geom_line(aes(x = date, y = load))
```

