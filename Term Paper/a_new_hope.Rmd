---
title: "a_new_hope"
author: "Gulbrand Galaasen"
date: "2024-05-09"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(zoo)
library(lubridate)
library(janitor)
library(hablar)
library(tsibble)
library(fpp3)
library(tseries)
```

```{r}
# Where our data ends
CUT_OFF <- "2024-05-01"

# The areas/connections-to we study
areas <- c("DE", "DK", "NL", "UK")

# Dates for when connections were fully operational
DE_conn <- "2021-05-27"
UK_conn <- "2021-10-01"


```


```{r}
# Exchange
cross_border_flow <- function(area, year) {
  read_csv(paste0("data/exchange/", area, "_", year, ".csv"),show_col_types = FALSE) %>% 
    .[,c(1,2,3)] %>% 
     `colnames<-`(c("date", "import", "export")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(import = as.double(import),
           export = as.double(export)) %>% 
    group_by(date) %>%
    summarize(exchange = sum(import, na.rm = TRUE) - sum(export, na.rm = TRUE)) %>% 
    mutate(area = area) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_cross_flow <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), cross_border_flow) %>% 
    bind_rows()
}

# Consumption
gather_load <- function(area, year) {
  read_csv(paste0("data/load_", area, "/load_", area, "_", year, ".csv")) %>% 
    .[,c(1,3)] %>% 
    `colnames<-`(c("date", "load")) %>% 
    drop_na() %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(load = as.double(load)) %>%
    group_by(date) %>% 
    summarize(load = sum(load)) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_load_area <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), gather_load) %>% 
    bind_rows() %>%  
    mutate(area = area)
}

# Generation
gather_generation <- function(area, year) {
  if (area == "NO") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv"), na = c("n/e", "N/A", "-")) %>% 
      .[,2:23] %>% 
      mutate(gen = rowSums(.[,2:22], na.rm = TRUE)) %>% 
      select(MTU, gen) %>% 
      rename(date = MTU) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>% 
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      group_by(date) %>% 
      summarize(gen = sum(gen)) %>% 
      filter(date < as.Date(CUT_OFF))
      
  } else {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv")) %>% 
      .[,c(2,20,22,23)] %>% 
      `colnames<-`(c("date", "sol", "wnd_off", "wnd_on")) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>% 
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      mutate(vrep = as.double(sol) + as.double(wnd_off) + as.double(wnd_on)) %>%
      group_by(date) %>% 
      summarize(vrep = sum(vrep)) %>% 
      filter(date < as.Date(CUT_OFF))
  }
}

gather_generation_area <- function(area) {
  # Special case for UK data as these are not present in Etsoe because of Brexit
  if (area == "UK") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, ".csv")) %>% 
      .[,c(3,6,7)] %>% 
      `colnames<-`(c("date", "type", "vrep")) %>%
      filter(type %in% c("WIND")) %>% 
      mutate(date = as.Date(with_tz(date, tzone = "Europe/Oslo"), tz = "Europe/Oslo")) %>% 
      group_by(date) %>%
      summarize(vrep = sum(as.double(vrep), na.rm = TRUE)) %>% 
      arrange(date) %>% 
      filter(date < as.Date(CUT_OFF)) %>% 
      mutate(area = area)
      
  } else {
    map2(rep(area, 7), c("2018":"2024"), gather_generation) %>% 
      bind_rows() %>%  
      mutate(area = area) 
  }
}
```

```{r, warning=FALSE, message=FALSE}
# Gather data

# Exchange
exchange <- map(areas, gather_cross_flow) %>%
  bind_rows()

# Consumption
load_NO <- gather_load_area("NO")

# Generation
gen_NO <- gather_generation_area("NO")

# Variable renewable production
vrep <- map(areas, gather_generation_area) %>% 
  bind_rows()
```

```{r}
df <- exchange %>% 
  inner_join(., vrep, by = c("date", "area")) %>% 
  inner_join(., gen_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., load_NO[,c(1,2)], by = c("date"))
```



```{r}
df %>% 
  filter(area == "DE") %>% 
  filter(exchange != 0) %>% 
  #filter(date >= as.Date("2020-12-09")) %>% 
  ggplot(aes(x = load, y = exchange, color = date)) +
  geom_point() +
  geom_smooth(method = "lm")
```



```{r}
df %>% 
  ggplot(aes(x = date, y = vrep, color = area)) + 
  geom_line()
```

