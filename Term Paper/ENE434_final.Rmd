---
title: "Projecting Norwegian Electricity Spot Prices Towards 2030: A Scenario Analysis"
author: "Candidates: 9 & 38"
date: "2024-05-15"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction 
 
The European energy landscape is undergoing a significant transformation towards sustainable solutions, propelled by increasing demands for renewable resources and enhanced concerns regarding energy security. While investment in variable renewable energy (VRE) sources such as wind and solar power is accelerating in Europe, geopolitical conflicts such as the Russian invasion of Ukraine in early 2022, has underscored the fragility of European energy supplies (windeurope, 2024). This event led to a significant reduction in the supply of natural gas, a pivotal energy source for many European countries and driver of power prices.

The objective of this study is to forecast Norwegian electricity spot prices towards 2030 aiming to assess the effect of variable renewable energy generation in Europe on power prices in Norway, as well as the implication of a higher domestic power consumption. In this paper we will assess the future power prices by variable renewable energy (VRE) generation, cross-border exchange from the UK and northern continental Europe, and domestic consumption on power prices in Norway.

## Background 
 
The supply crisis has affected the Norwegian power market dynamics due to the market coupling and transmission interconnections with Europe. The market coupling and interconnectors facilitates the exchange of power to and from Norway, thereby enhancing grid stability, bolstering regional energy security, and ensuring the socially optimum allocation of scarce energy resources. Consequently, high demand or high carbon emission prices in Germany can lead to increased prices across connected markets, including Norway, due to the physical and market linkages. Conversely, in periods with abundant intermittent renewable energy production in neighboring regions, Norway can reduce its reliance on hydropower reserves, potentially lowering the electricity prices due to the import of cheaper energy. The interconnectors which connect the Norwegian power market to European power markets contributes to greater price volatility and higher price levels in the Norwegian power market - which have traditionally been low compared to continental Europe. This is mainly due to flexible hydro power generation with low marginal cost of production which makes up approximately 90% of the total power generation (SSB, 2023). As the EU intensifies efforts to phase out fossil fuels, the demand for renewable energy and investments in renewable energy generation in Europe will continue its upward trajectory (European Commission, 2024). 
 
We acknowledge that there are complexities and idiosyncrasy of factors in the power market that this paper fail to account for. The choice of topic and assumptions made are justified by our interest and wish to better understanding the impact of renewable energy integration and domestic consumption on electricity prices. The simplifications and methodologies used in our analysis is chosen in order to focus on the most influential variables within the scope of our study.

## Literature review 
In recent years, changes in market dynamics have led to an incremental increase in energy costs for Norwegian consumers (SSB, 2023). Meanwhile, power producers benefit from enhanced market coupling as profit margins proportionately increase as wholesale electricity prices surge. The future price levels for electricity will likely be influenced by the marginal costs of available energy technologies needed to meet demand, coupled with the cross-border exchange capacities necessary to transport electricity effectively. Reseach shows that increased generation capacity of intermittent renewable energy sources contribute to lower electricity prices. The effects of VRE on price volatility is inconclusive, however, although a majority of research papers indicate a significant positive relationship between renewable electricity generation and electricity price volatility (Gjerland & Gjerde, 2020). Nonetheless, the complex interdependencies introduced by cross-border energy trading, the mechanisms which determine prices across regions and the variability of renewable energy generation, highlight the challenges in forecasting future electricity prices accurately. This is partly due to the complexity of the the mechanisms that determines power prices. 

The wholesale electricity spot price in Norway is calculated a day in advance for each bidding zone. This hourly price determination is carried out at Nord Pool, the Nominated Electricity Market Operator (NEMO) for the Nordic region. The optimization algorithm EUPHEMIA aggregates supply and demand bids across all European NEMOs. During this process, power plants within each zone are ranked by increasing marginal costs, following the merit order of dispatch. The system spot price, determined simultaneously for all bidding zones, represents the theoretical price assuming no transmission constraints exist. However, actual zonal prices are derived from managing congestion in inter-zonal transmission capacities, thus dividing different areas into bidding zones (energifaktanorge, 2024). EUPHEMIA also calculates these zonal prices simultaneously, effectively determining them through the equilibrium of supply and demand achieved by the optimal power flow and dispatch given the transmission constraints between zones. Any mismatches in supply and demand are further addressed in the intraday market and through ancillary services provided by Transmission System Operators (TSOs) (Cretì & Fontini, 2019).
 
The transmission capacity of interconnectors is a fundamental constraint that affects the cross-border power exchange and how electricity prices are set in Norway. When there is high demand in neighboring countries, the capacity of these interconnectors becomes a constricting factor. If the demand cannot be fully met due to transmission constraints, it leads to congestion. Congestion in the transmission network results in zonal price differences; areas with surplus power supply might experience lower prices, whereas areas with deficits face higher prices (Creti & Fontini, 2019). Norway's ability to export or import electricity gives it a unique position to balance domestic supply and demand while also being prone to fluctuations in the wider European market. This dynamic creates a situation where Norwegian electricity prices are not only a function of domestic factors but also deeply influenced by the broader European energy landscape. Therefore, understanding the interplay between transmission capacity, international energy markets, and local generation capabilities is crucial for predicting future price development. 

```{r, warning = FALSE, message = FALSE}
# The following r-packages are used in our script. 
library(tidyverse)
library(zoo)
library(lubridate)
library(janitor)
library(hablar)
library(tsibble)
library(fpp3)
library(tseries)
library(forecast)
library(pander)
```

## Collecting data 

In this section we will detail the sources from which our data is gathered, and the methods used to load and wrangle the data. In the analysis we use data on the historical day-ahead spot prices for the five Norwegian bidding zones, load and generation in Norway, in addition to cross-border exchange and variable renewable energy generation in interconnected zones in the UK, Denmark, Germany and the Netherlands. All data is retrieved in an hourly resolution for the period between January 2018 and May 2024. Data for all countries except the UK is retrieved from ENTSO-E’s Transparency Platform (Transparency Platform, 2024). Due to Brexit, historical UK was no longer offered by ENTSO-E and is instead retrieved from ELEXON BSC’s Insight Solutions (Insights Solution, 2024). 

Spot prices are measured in units of Euro/MWh and retrieved for all five bidding zones: NO1, NO2, NO3, NO4 and NO5. All other data is measured in power units of MW. Data on load and generation of power are retrieved separately for all five bidding zones. Meanwhile, data on cross-border exchange and variable renewable energy generation is retrieved for interconnectors in the North Sea. Due to the scope of this paper, we have chosen not to include the interconnectors to Sweden and Finland. We acknowledge that this exclusion is a potential weakness of our analysis. 


## Summary of findings 
* The mean Norwegian spot price of electricity is projected to be 53.96 €/MWh from today towards 2030, given current levels of VRE and consumption.
* A 50% increase towards 2030 in variable renewable energy production in countries with an oversea connection, the mean price will be 50.73  €/MWh, 5.99%% lower than the base scenario.
* A 10% increase towards 2030 in domestic consumption the mean price will be 59.4 €/MWh, 10.08% higher than the base scenario. 
* An increase in both variable renewable energy and consumption, the mean price will be 56.17 €/MWh, 4.09% lower than the base scenario.  

```{r, warning=FALSE, message=FALSE}
# Where our data ends
CUT_OFF <- "2024-05-01"

# The areas/connections-to we study
areas <- c("DE", "DK", "NL", "UK")

# Bidding zones for Norwegian day-ahead electricity prices
bidding_zone <- c("NO1", "NO2", "NO3", "NO4", "NO5")
```

We first establish global variables which will be used to denominate cross-border areas (bidding zones) and Norwegian bidding zones. In addition, we set the cut-off date applied to all the loaded datasets. All data collected has a common start date of 1. January 2018. 

Datasets downloaded from ENTSO-E are only available for one year at a time. We write functions for each variable which load, wrangle and clean the 7 files for each year and bidding zone as inputs. The functions aggregate the hourly resolution to mean prices by date. The mean prices in each bidding zones in Norway is aggregated into a single mean price for each date for simplicity. Subsequent functions gather and consolidate the yearly data for each variable. Negative values for exchange signify export of Norwegian generation. Conversely, positive exchange values signify import. 

```{r, warning=FALSE, message=FALSE}
# Prices
dayAheadPrices <- function(bidding_zone, year) {
  read_csv(paste0("data/Norwegian_Day_Ahead_prices/DA_price_", bidding_zone, "_", year, ".csv"),show_col_types = FALSE) %>% 
    .[,c(1,2)] %>% 
     `colnames<-`(c("date", "price")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(price = as.double(price),
           bidding_zone = bidding_zone) %>%
    group_by(date) %>%
    filter(date < as.Date(CUT_OFF)) %>%
    summarise(price = mean(price, na.rm = TRUE), bidding_zone = unique(bidding_zone))
}

gather_dayAheadPrices <- function(bidding_zone) {
  map2(rep(bidding_zone, 7), c("2018":"2024"), dayAheadPrices) %>% 
    bind_rows()
}


# Exchange
cross_border_flow <- function(area, year) {
  read_csv(paste0("data/exchange/", area, "_", year, ".csv"), show_col_types = FALSE) %>% 
    .[,c(1,2,3)] %>% 
     `colnames<-`(c("date", "import", "export")) %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(import = as.double(import, na.rm = TRUE),
           export = as.double(export, na.rm = TRUE)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    group_by(date) %>%
    summarize(exchange = mean(import, na.rm = TRUE) - mean(export, na.rm = TRUE)) %>% 
    mutate(area = area) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_cross_flow <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), cross_border_flow) %>% 
    bind_rows()
}


# Consumption
gather_load <- function(area, year) {
  read_csv(paste0("data/load_", area, "/load_", area, "_", year, ".csv")) %>% 
    .[,c(1,3)] %>% 
    `colnames<-`(c("date", "load")) %>% 
    drop_na() %>% 
    separate(date, sep="-", into=c("date", NULL)) %>% 
    mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
    mutate(load = as.double(load)) %>%
    group_by(date) %>% 
    summarize(load = mean(load)) %>% 
    filter(date < as.Date(CUT_OFF))
}

gather_load_area <- function(area) {
  map2(rep(area, 7), c("2018":"2024"), gather_load) %>% 
    bind_rows() %>%  
    mutate(area = area)
}

# Generation
gather_generation <- function(area, year) {
  if (area == "NO") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv"), na = c("n/e", "N/A", "-")) %>% 
      .[,2:23] %>% 
      mutate(gen = rowSums(.[,2:22], na.rm = TRUE)) %>% 
      select(MTU, gen) %>% 
      rename(date = MTU) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>%
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      group_by(date) %>% 
      summarize(gen = mean(gen)) %>% 
      filter(date < as.Date(CUT_OFF))
      
  } else {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, "_", year, ".csv")) %>% 
      .[,c(2,20,22,23)] %>% 
      `colnames<-`(c("date", "sol", "wnd_off", "wnd_on")) %>% 
      drop_na() %>% 
      separate(date, sep="-", into=c("date", NULL)) %>% 
      mutate(vre = as.double(sol) + as.double(wnd_off) + as.double(wnd_on)) %>%
      mutate(date = as.Date(date, "%d.%m.%Y %H:%M")) %>% 
      group_by(date) %>% 
      summarize(vre = mean(vre)) %>% 
      filter(date < as.Date(CUT_OFF))
  }
}

# Generation
gather_generation_area <- function(area) {
  # Special case for UK data as these are not present in Etsoe because of Brexit
  if (area == "UK") {
    read_csv(paste0("data/generation/gen_", area, "/gen_", area, ".csv")) %>% 
      .[,c(3,6,7)] %>% 
      `colnames<-`(c("date", "type", "vre")) %>%
      filter(type %in% c("WIND")) %>% 
      mutate(vre = as.double(vre)) %>% 
      mutate(date = as.Date(with_tz(date, tzone = "Europe/Oslo"), tz = "Europe/Oslo")) %>% 
      group_by(date) %>%
      summarize(vre = mean(vre, na.rm = TRUE)) %>% 
      arrange(date) %>% 
      filter(date < as.Date(CUT_OFF)) %>% 
      mutate(area = area)
      
  } else {
    map2(rep(area, 7), c("2018":"2024"), gather_generation) %>% 
      bind_rows() %>%  
      mutate(area = area) 
  }
}
```

Data frames for each variable are loaded into memory and subsequently consolidated into the data frame df. There exist some NaN values in exchange due to maintenance which we set to 0. 

```{r, warning=FALSE, message=FALSE}
# Load data into memory

# Prices
price <- map(bidding_zone, gather_dayAheadPrices) %>%
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(price = mean(price, na.rm = TRUE))

# Exchange
exchange <- map(areas, gather_cross_flow) %>%
  bind_rows()

# Consumption
load_NO <- gather_load_area("NO")

# Generation
gen_NO <- gather_generation_area("NO")

# Variable renewable production
vre <- map(areas, gather_generation_area) %>% 
  bind_rows()
```

```{r, warning=FALSE, message=FALSE}
df <- exchange %>% 
  inner_join(., vre, by = c("date", "area")) %>% 
  inner_join(., gen_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., load_NO[,c(1,2)], by = c("date")) %>% 
  inner_join(., price[,c(1,2)], by = c("date"))

is.nan.data.frame <- function(x)
do.call(cbind, lapply(x, is.nan))
df[is.nan(df)] <- 0
```

## Stationarity testing

Before we do anything else we want to ensure that the data we will later use is stationary. This is done by conducting an Augmented Dickey-Fuller (adf) test.

```{r, warning=FALSE, message=FALSE}
df_adf_test <- df %>% 
  group_by(date) %>% 
  summarise(price = first(price),
            gen = first(gen),
            load = first(load))

ex_DE <- df %>% filter(area == "DE")
ex_DK <- df %>% filter(area == "DK")
ex_NL <- df %>% filter(area == "NL")
ex_UK <- df %>% filter(area == "UK")
  

adf.test(df_adf_test$price) # stationary
adf.test(df_adf_test$gen) # stationary
adf.test(df_adf_test$load) # not stationary

adf.test(ex_DE$exchange) # stationary
adf.test(ex_DK$exchange) # stationary
adf.test(ex_NL$exchange) # stationary
adf.test(ex_UK$exchange) # stationary
```
We find that all data is stationary within a statistically significant level, except the load (consumption) data, which is likely because of its seasonality. This will be addressed by introducing measures to account for seasonality in all forecasting models where the consumption is present as a variable.

## Descriptive analysis

To create a price-model using exchange, load and vre as explanatory variables, we need to synthesize future data for these variables. Additionally, the model must account for the maximum transmission capacity of each interconnector, ensuring that exchange cannot exceed the physical constraints of transmission. 

Descriptive analysis of the data will provide insight into the drivers for each variable, enabling us to synthesize scenarios of future data to be used in our final price-model. Below is the code for the scatterplots with linear regression lines for the explanatory variables, facet wrapped by area. 

The scatterplots will enable us to better understand how the correlation between one explanatory variable and the other for each area. 

## Descriptive analysis of price

To achieve our overall goal of projecting future price levels, we first need to gain insight into what drives prices. 

```{r, warning = FALSE, message = FALSE}
price_df <-
  df %>% 
  group_by(date) %>% 
  summarise(price = first(price),
            gen = first(gen),
            load = first(load),
            exchange = sum(exchange)) %>% 
  pivot_longer(cols = c("exchange", "gen", "load"))

price_df %>% 
  filter(value != 0) %>% 
  ggplot(aes(x = value, y = price, color = date)) +
  geom_point(cex = 0.7) +
  facet_wrap(~ name, scales = 'free_x')+
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Price drivers", x = "value", y = "Price in €/MWh", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

```

Plotting exchange, generation and consumption to explain price, we see that there are different and complex relations. First, data points form clusters based on their date, which makes sense as different periods since 2018 have had different price levels, with some periods being abnormally high. 

For exchange it is difficult to pinpoint any exact relation to price. High exports (negative exchange) and imports (positive exchange) seem to give higher prices than small export and small import values. Additionally, different time periods for when the exchange occurred seem to display different relations to price. The difficulty of determining this relationship calls for more complex methods, which we later will implement.  

For generation, low and high values seem to be correlated positively with higher prices. This makes intuitively sense, as abnormally low generation likely indicates lack of production capacity which is needed, and abnormally high generation indicates that higher merit order production types are used, which has a higher marginal production cost.  

For load, there seems to exist a positive linear trend, which makes sense as lower consumption requires less production, and the lowest marginal cost production types and facilities are used. When the consumption is higher the opposite is true, and the price is therefore higher. Interestingly, there also seems to exist a trend in some time periods like that of generation, where lower and higher values correlate with a higher price. 

Based on the analysis above, we can conclude that a more complex model than linear regression is needed to project long term future prices. If we want to do this, we will need to synthesize the variables discussed. We start by synthesizing exchange by creating forecasting models for each connected overseas area. Before this we conduct a similar analysis where we identify potential drivers for exchange. 

## Descriptive analysis of exchange

```{r, warning = FALSE, message = FALSE}
Facet_gen <- df %>% 
  select(date, exchange, area, gen) %>% 
  filter(exchange != 0) %>% 
  ggplot(aes(x = gen, y = exchange, color = date)) +
  geom_point(cex = 0.7) +
  facet_wrap(~ area, scales = 'free_y')+
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Exchange explained by Generation", x = "Generation", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Facet_vre <- df %>% 
  select(date, exchange, area, vre) %>% 
  filter(exchange != 0) %>% 
  ggplot(aes(x = vre, y = exchange, color = date)) +
  geom_point(cex = 0.7) +
  facet_wrap(~ area, scales = 'free')+
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Exchange explained by VRE", x = "VRE", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

Facet_load <- df %>% 
  select(date, exchange, area, load) %>% 
  filter(exchange != 0) %>% 
  ggplot(aes(x = load, y = exchange, color = date)) +
  geom_point(cex = 0.7) +
  facet_wrap(~ area, scales = 'free')+
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Exchange explained by Consumption", x = "Consumption", y = "Exchange", color = "Date") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
```

```{r, warning=FALSE, message=FALSE}
Facet_gen
```

The plot above indicates a negative correlation between exchange and generation in NO across all areas, meaning an increase in export is correlated with an increase in NO generation. The incline of the regression lines suggests the degree of correlation is similar in size(forholdet?). NO appears to be a net exporter to all areas, although this is less evident for DK. The correlation between generation and exchange seems to be more prominent for DE and DK, than NL and UK. This might suggest that Norwegian power producers are more capable of adjusting generation to power imported from DE and DK, or that power generation in DK is more prevalent during periods of low power generation in Norway, possibly due to high water values. 
```{r, warning=FALSE, message=FALSE}
Facet_vre
```

The plot above indicates a varying degree of positive correlation between exchange and variable renewable energy production in border areas, showing a trend of import when vre is available. However, this correlation is negligible for the UK. Conversely, DK and DE appear to have a linear relationship between exchange and vre. This might suggest that vre production is a driver for exchange between NO and these areas. This does not seem to be the case for UK where slope has no incline.  

```{r}
Facet_load
```

The plot above shows different correlations between exchange and load for bordering areas. Exchange to DE, DK and NL are positively correlated with NO load, while this relationship is opposite for the UK, exchange being is negatively correlated with load. The former suggest that with lower power consumption in Norway, power export increases. The latter might suggest that an increase in consumption of electricity in Norway relates to more export to the UK, however, there are some outliers to the right of the plot which might explain the slope of the regression line.   

```{r, warning=FALSE, message=FALSE}
get_coeff_gen <- function(a) {
  df %>% 
    select(date, exchange, area, gen) %>% 
    filter(exchange != 0) %>% 
    filter(area == a) %>% 
    lm(data = ., formula = exchange ~ gen) %>% 
    summary(.) %>% 
    .$coefficients %>% 
    as_tibble() %>% 
    .[2,c("Estimate", "Pr(>|t|)")] %>%
    `colnames<-`(c("coeff", "p_value")) %>% 
    mutate(p_value = ifelse(p_value > 0.1, "-", 
                     ifelse(p_value > 0.05, "*", 
                     ifelse(p_value > 0.01, "**", "***")))) %>% 
    mutate(coeff = paste0(round(coeff, 3), " ", p_value)) %>% 
    .$coeff
}

get_coeff_vre <- function(a) {
  df %>% 
    select(date, exchange, area, vre) %>% 
    filter(exchange != 0) %>% 
    filter(area == a) %>% 
    lm(data = ., formula = exchange ~ vre) %>% 
    summary(.) %>% 
    .$coefficients %>% 
    as_tibble() %>% 
    .[2,c("Estimate", "Pr(>|t|)")] %>%
    `colnames<-`(c("coeff", "p_value")) %>% 
    mutate(p_value = ifelse(p_value > 0.1, "-", 
                     ifelse(p_value > 0.05, "*", 
                     ifelse(p_value > 0.01, "**", "***")))) %>% 
    mutate(coeff = paste0(round(coeff, 3), " ", p_value)) %>% 
    .$coeff
}

get_coeff_load <- function(a) {
  df %>% 
    select(date, exchange, area, load) %>% 
    filter(exchange != 0) %>% 
    filter(area == a) %>% 
    lm(data = ., formula = exchange ~ load) %>% 
    summary(.) %>% 
    .$coefficients %>% 
    as_tibble() %>% 
    .[2,c("Estimate", "Pr(>|t|)")] %>%
    `colnames<-`(c("coeff", "p_value")) %>% 
    mutate(p_value = ifelse(p_value > 0.1, "-", 
                     ifelse(p_value > 0.05, "*", 
                     ifelse(p_value > 0.01, "**", "***")))) %>% 
    mutate(coeff = paste0(round(coeff, 3), " ", p_value)) %>% 
    .$coeff
}

tibble(area = areas) %>% 
  mutate(gen = unlist(map(areas, get_coeff_gen)),
         vre = unlist(map(areas, get_coeff_vre)),
         load = unlist(map(areas, get_coeff_load))) %>% 
  pander()
```
The table above shows the summarized numerical results for the descriptive regression analysis. Gen is negatively correlated with exchange for all areas. For VRE, there is a positive correlation for all areas, the greatest being for DK. We note that only the coefficient for VRE and UK is not significant. Load and exchange are positively correlated for DE, DK and NL, while being negatively correlated for UK. 

## Forecast exchange

Next, we want to forecast exchange between Norway and countries that are connected with an oversea cable. These include Germany (DE), Denmark (DK), the Netherlands (NL) and United Kingdom (UK). We first define capacity parameters on all cables using the historical maximum and minimum we find in the data. Secondly, we define a date range which sets the timeline for the forecast. Lastly, we need to define how the increase in consumption and variable renewable energy will happen. Here we use a simple linear increase in both, such that the level at any given time will be the original level multiplied with the target level and percentage of the time elapsed to 2030. To give an example for the variable renewable energy production, the first date (2024-05-01) in our forecast will be the level multiplied by 1. The median date (2027-02-02) will be the level multiplied by 1.25, and the last date (2029-12-31) will be the level multiplied with 1.5. Thus, we model a 50% total increase in variable renewable energy production over the given forecast horizon.   


```{r, warning=FALSE, message=FALSE}
cap <- tibble(area = c("DE", "DK", "NL", "UK"),
              import_cap = c(1425, 1639, 730, 1330),
              export_cap = c(-1407, -1658, -706, -1450),
              from_date = c("2021-01-01", "2021-01-01", "2023-01-01", "2022-01-01"))

DATE_RANGE <- seq(as.Date(CUT_OFF), as.Date("2029-12-31"), by = "day")

N_DAYS <- length(DATE_RANGE)

load_inc <- (seq(1:N_DAYS) / N_DAYS * 0.1) + 1
vre_inc <- (seq(1:N_DAYS) / N_DAYS * 0.5) + 1

```

Since we want to forecast the exchange with variable renewable energy production and consumption, we need to synthesis data for these variables in the forecast horizon. 

We start by synthesizing variable renewable production. This is done by taking data from 2023 and creating a pool of values for each month and area. Then for a single date, a future value is drawn from this pool given a month and area, and is then multiplied by a random factor [0.9, 1.1] to essentially simulate the uncertainty of wind and solar for a given day. Doing it this way the idea is to keep monthly trends for future values, while also introducing uncertainty that is present in such a variable. 

```{r, warning=FALSE, message=FALSE}
# Synthesize vre
vre_area_month <-
  df %>% 
  filter(date >= as.Date("2023-01-01")) %>% 
  filter(date < as.Date("2024-01-01")) %>% 
  mutate(month = month(date)) %>% 
  select(month, area, vre)

draw_vre <- function(a, m) {
  vre_area_month %>%
    filter(area == a) %>% 
    filter(month == m) %>% 
    .$vre %>% 
    sample(1, replace = TRUE) * runif(1, min = 0.9, max = 1.1)
} 
```

We also need to synthesize the future consumption. We can do this using the same method as for the variable renewable energy production, but the seasonality would not be kept in a good way. Therefore, we instead synthesize the data by creating an ARIMA model with fourier terms to create more feasible data. Here a fourier term is added for yearly and weekly seasonality. The model also includes an AR(3) and MA(1), these parameters were found by looking at the residual plot and studying the AICc. 

```{r, warning=FALSE, message=FALSE}
load_data <- df %>% 
  group_by(date) %>% 
  summarise(load = first(load)) %>% 
  tsibble(index = date) 

load_model <- 
  load_data %>% 
  model(mod = ARIMA(load ~ pdq(3,0,1) + PDQ(0,0,0) +
                      fourier(period = 365, K = 10) +
                      fourier(period = 7, K = 3)
                    )
  )

load_model %>% gg_tsresiduals()

future_load <-
  load_model %>% 
  forecast(h = N_DAYS) %>% 
  rename(steady_load = .mean) %>% 
  mutate(increasing_load = steady_load * load_inc) %>% 
  select(date, steady_load, increasing_load)

future_load %>% 
  ggplot() +
  geom_line(aes(x = date, y = steady_load, color = "steady load")) + 
  geom_line(aes(x = date, y = increasing_load, color = "increasing load")) +
  labs(x = "Date", y = "Load", title = "Increasing and steady load to 2030")

```

The final model still has some residual peaks on the 21st, 23rd and 25th lag, but the residual histogram looks normally distributed. Another point here is that we do not necessarily want the model to exactly fit the data, but rather we want the forecast to look feasible. The plot of increasing and steady load to 2030 illustrates that this is indeed the case, and we accept the model. 

Next, we define a function which creates a dataset for each exchange area. This dataset will include the historical data on the variable renewable production and consumption, and the scenarios for future variable renewable production and consumption, namely for steady and increasing states. 

```{r, warning=FALSE, message=FALSE}

create_dataset_area <- function(a) {
  from_date <- cap %>% 
    filter(area == a) %>% 
    .$from_date
  
  old_df <-
    df %>% 
    filter(area == a) %>% 
    filter(date >= as.Date(from_date)) %>% 
    select(date, area, exchange, vre, load) %>% 
    mutate(increasing_vre = NA,
           increasing_load = NA)
  
  new_df <- 
    tibble(date = DATE_RANGE,
           area = a,
           exchange = NA,
           vre = unlist(map2(a, month(date), draw_vre)),
           increasing_vre = unlist(map2(a, month(date), draw_vre)) * vre_inc,
           load = future_load$steady_load,
           increasing_load = future_load$increasing_load)

  return(
    rbind(old_df, new_df) %>% 
      tsibble(index = date) 
  )
} 

```


```{r, warning=FALSE, message=FALSE}

forecast_exchange <- function(a) {
  print(paste0("Exchange model for area: ", a))
  
  import_cap <- cap %>% 
    filter(area == a) %>% 
    .$import_cap
  
  export_cap <- cap %>% 
    filter(area == a) %>% 
    .$export_cap
  
  data <- create_dataset_area(a)
  
  data_fit <- data %>% 
    filter(date < as.Date(CUT_OFF))
  
  data_pred <- data %>% 
    filter(date >= as.Date(CUT_OFF))
  
  model <- 
    data_fit %>% 
    fill_gaps() %>%
    model(mod = ARIMA(exchange ~ vre + load + fourier(period = 7, K = 3)))
  
  print(model$mod)
  
  model %>% 
    gg_tsresiduals() %>% 
    print()
  
  # Scenario 1: steady vre and steady load
  pred1 <- 
    model %>% 
    forecast(., new_data = data_pred) %>% 
    mutate(s1 = unlist(map2(.mean, rep(import_cap, N_DAYS), min))) %>% 
    mutate(s1 = unlist(map2(s1, rep(export_cap, N_DAYS), max))) 
  
  # Scenario 2: Increasing vre and steady load
  pred2 <- 
    model %>% 
    forecast(., new_data = (data_pred %>% mutate(vre = increasing_vre))) %>% 
    mutate(f = unlist(map2(.mean, rep(import_cap, N_DAYS), min))) %>% 
    mutate(f = unlist(map2(f, rep(export_cap, N_DAYS), max)))

  # Scenario 3: Steady vre and increasing load
  pred3 <- 
    model %>% 
    forecast(., new_data = (data_pred %>% mutate(load = increasing_load))) %>% 
    mutate(f = unlist(map2(.mean, rep(import_cap, N_DAYS), min))) %>% 
    mutate(f = unlist(map2(f, rep(export_cap, N_DAYS), max)))

  # Scenario 4: Increasing vre and increasing load
  pred4 <- 
    model %>% 
    forecast(., new_data = (data_pred %>% mutate(vre = increasing_vre, load = increasing_load))) %>% 
    mutate(f = unlist(map2(.mean, rep(import_cap, N_DAYS), min))) %>% 
    mutate(f = unlist(map2(f, rep(export_cap, N_DAYS), max)))
  
  pred <- pred1 %>% 
    mutate(s2 = pred2$f,
           s3 = pred3$f,
           s4 = pred4$f)

  return(pred %>% 
           as_tibble() %>% 
           select(date, area, s1, s2, s3, s4))
}

set.seed(434) # Set seed for reproducibility
exchange_forecast <- map(areas, forecast_exchange) %>% 
  bind_rows() %>% 
  group_by(date) %>% 
  summarise(s1 = sum(s1),
            s2 = sum(s2),
            s3 = sum(s3),
            s4 = sum(s4))
```
In this analysis, we develop a distinct model for each geographical area to account for the unique relationships between exchange and variable renewable energy production inherent to each region. We allow the algorithm to autonomously determine the optimal ARIMA parameters for each area, while a Fourier term is consistently applied across all models to capture weekly seasonality. 

For the DE-model, the residuals are normally distributed with minor spikes, and it selects an ARIMA(1,1,2)(2,0,0)[7] configuration. Although additional Fourier terms could potentially be added, we opt against it to prevent overfitting the model. 

The DK-model exhibits no residual spikes and the residuals appear normally distributed, leading to the selection of an ARIMA(2,1,1)(2,0,1)[7] model. 

The NL-model also shows no residual spikes with normally distributed residuals, adopting an ARIMA(2,0,1)(2,0,0)[7] model. Despite its lack of an I(1) term to account for non-stationarity, this model is deemed the most fitting for the data. 

The UK-model displays some residual spikes, yet the residuals are normally distributed. It utilizes an ARIMA(2,1,1) model. Given the anomalies observed in the exchange data for the UK compared to other regions, achieving a perfect model is challenging, and thus this model is accepted as sufficiently accurate for the data at hand.  

## Price projection

To construct our price model, we begin by integrating synthesized data on exchange and consumption. The model will be calibrated using historical data from the period January 1, 2022, to May 1, 2024. This specific timeframe is chosen to exclude the extraordinary price levels of 2021, which we assess as unrepresentative of future trends in Norwegian electricity prices. 

Initially, we compile the fitting data, incorporating historical records of prices, exchange rates, and consumption levels. Subsequently, we assemble a data frame to store exchange and consumption metrics across all predefined scenarios. This structured approach enables us to systematically project the electricity prices in Norway for each scenario. We chose to omit generation as a variable from the model due to the characteristics of Norway's predominantly hydropower-based generation. The dispatch flexibility of hydro power allow producers to quickly adjust output in response to anticipated price fluctuations. Including generation in the model could introduce a circular dependency, where prices influence generation decisions, and these adjusted generation levels in turn affect prices. Therefore, we argue that synthesizing generation is not feasible.

```{r, warning=FALSE, message=FALSE}
pdf <- df %>% 
  group_by(date) %>% 
  summarise(price = first(price),
            exchange = sum(exchange),
            load = first(load)) %>% 
  filter(date >= as.Date("2022-01-01")) %>% 
  tsibble(index = date)
  
future <- 
  exchange_forecast %>% 
  mutate(steady_load = future_load$steady_load,
         increasing_load = future_load$increasing_load) %>% 
  tsibble(index = date)
```

Next we define our model using the same methodology as before. We want to have as few spikes in the ACF-plot as possible and the residuals to be normally distributed. We account for seasonality by adding Fourier terms. After some testing we find a model with MA(3), and three different fourier terms.    

```{r, warning=FALSE, message=FALSE}
model <- 
  pdf %>% 
  fill_gaps() %>%
  model(mod = ARIMA(price ~ exchange + load + pdq(0,1,3) + PDQ(0,0,0) +
                      fourier(period = 6, K = 2) +
                      fourier(period = 7, K = 1) +
                      fourier(period = 9, K = 4)))

model %>% 
  report()

model %>% 
  gg_tsresiduals()
```
The residuals of the model appear to be normally distributed overall, yet there is an unadjusted spike at lag 13. Modeling price data accurately is challenging due to its susceptibility to numerous influencing factors and events. Examination of the residuals reveals that the model particularly struggles with fitting the data from late 2022, likely due to the unusually high prices recorded during this period. As our goal is to project a generalized price level over an extended timeframe, we acknowledge and accept these limitations within our model. 

Moving forward, we will proceed to create forecasts for each scenario using the corresponding data. 

```{r, warning=FALSE, message=FALSE}
# Scenario 1
print("Scenario 1: Steady vre and steady load")
pred1 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = s1, load = steady_load)))

pred1 %>% 
  autoplot(pdf) +
  labs(title = "Projection for Scenario 1", x = "Date", y = "Price in €/MWh")

# Scenario 2
print("Scenario 2: Increasing vre and steady load")
pred2 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = s2, load = steady_load))) 

pred2 %>% 
  autoplot(pdf) +
  labs(title = "Projection for Scenario 2", x = "Date", y = "Price in €/MWh")

# Scenario 3
print("Scenario 3: Steady vre and increasing load")
pred3 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = s3, load = increasing_load))) 

pred3 %>% 
  autoplot(pdf) +
  labs(title = "Projection for Scenario 3", x = "Date", y = "Price in €/MWh")

# Scenario 4
print("Scenario 4: Increasing vre and increasing load")
pred4 <- 
  model %>% 
  forecast(., new_data = (future %>% mutate(exchange = s4, load = increasing_load))) 

pred4 %>% 
  autoplot(pdf) +
  labs(title = "Projection for Scenario 4", x = "Date", y = "Price in €/MWh")

```
Looking at the projections for the different scenarios, they all share a similar seasonality, where the prices are lower in the summer months and higher during the winter months. As time elapses, the uncertainty of the projection increases, an expected result due to the limited explanatory power of the model. This is also emphasized by the residual plot above. It should also be noted that the model does not differentiate between negative and positive prices and finds each as likely. Domain knowledge of electricity markets does not support this notion. Negative prices are a relatively rare occurrence and are very unlikely to dip far below zero. However, our goal is to compare general price levels of different scenarios, rather than trying to give an exact forecast, and this model will in this regard be suitable.  

The projections across the different scenarios exhibit consistent seasonal patterns, with lower prices typically observed during the summer months and higher prices in the winter. Over time, the projections become increasingly uncertain, a natural consequence of the model's limited capacity to encapsulate all influencing factors—this limitation is also highlighted in the residual plot. Notably, the model does not distinguish between negative and positive prices, treating both as equally probable. However, from a practical standpoint in electricity markets, negative prices are infrequent and seldom drop substantially below zero. 

Despite these limitations, the primary aim of this analysis is not to predict exact future prices but to compare the general price levels across different scenarios. In this context, we evaluate the model to be suited for illustrating how the explanatory variables might influence general pricing trends over the coming years. 
 
```{r, warning=FALSE, message=FALSE}
tibble(Scenario = c("Scenario 1", "Scenario 2", "Scenario 3", "Scenario 4"),
       vre = c("Steady", "Increasing", "Steady", "Increasing"),
       load = c("Steady", "Steady", "Increasing", "Increasing"),
       Mean = c(paste0(round(mean(pred1$.mean), 2), " €/MWh"), 
                paste0(round(mean(pred2$.mean), 2), " €/MWh"), 
                paste0(round(mean(pred3$.mean), 2), " €/MWh"), 
                paste0(round(mean(pred4$.mean), 2), " €/MWh")),
       "% diff mean" = 
         c(
           paste0(round(-(mean(pred1$.mean) - mean(pred1$.mean)) / mean(pred1$.mean) * 100, 2), "%"), 
           paste0(round(-(mean(pred1$.mean) - mean(pred2$.mean)) / mean(pred1$.mean) * 100, 2), "%"),
           paste0(round(-(mean(pred1$.mean) - mean(pred3$.mean)) / mean(pred1$.mean) * 100, 2), "%"), 
           paste0(round(-(mean(pred1$.mean) - mean(pred4$.mean)) / mean(pred1$.mean) * 100, 2), "%")),
       std = c(sqrt(var(pred1$.mean)), 
               sqrt(var(pred2$.mean)), 
               sqrt(var(pred3$.mean)), 
               sqrt(var(pred4$.mean)))) %>% 
  pander()
```
In the table above the calculated mean and standard deviation for each scenario are presented. We compare each scenario with Scenario 1 to examine how an increase in variable renewable production and an increase in consumption affects the spot price level prior to 2030. 

Scenario 2, where a 50% increase in variable renewable energy production and steady consumption is modeled, has a 5.99% lower price level than the base scenario. This result coincides with our intuition; higher production in the overseas areas is associated with import in Norway, shifting the supply curve to the right leading to a decrease in price levels.  The standard deviation, which we interpret as price volatility, is somewhat lower. This is not what we would expect, as an increase in variable renewable energy would induce higher volatility in the overseas production, which again would transfer to the supply curve in Norway. This might be because of the bottlenecks of transmission, or that the granularity of the aggregated data loses explanatory power. Our modelling assumptions and simplifications might also be the cause of this. 

Scenario 3, where steady variable renewable energy production and a 10% increasing consumption is modeled, we estimate a 10.08% increase in the price level compared to Scenario 1. This aligns with our intuition, where a higher consumption shifts the demand curve to the right, resulting in higher prices. Here the standard deviation is also higher than Scenario 1, which also makes intuitive sense as a right shift in demand generally increases the price. 

Scenario 4, where VRE increases by 50% and load increase by 10% result in a 4.09% increase in the price level compared to Scenario 1. After examining Scenario 2 and 3, this seems somewhat reasonable, indicating that the effect of an increase of 10% in consumption is larger than the effect of an increase of 50% in variable renewable energy generation. The standard deviation is lower than Scenario 3 but still higher than Scenario 1, which aligns with what we found in the comparison of mean price levels. 

## Findings 
We find that a 50% increase in variable renewable energy production towards 2030 in Germany, Denmark, the Netherlands, and the United Kingdom, gives a 5.99% reduction in the Norwegian spot price level compared to no increase at all. The opposite is true for a 10% increase in domestic consumption, which gives a 10.08% increase in the Norwegian spot price level compared to no increase at all. Combining both gives a reduction in the price level of 4.09%. Overall, it seems like the effect of an increased consumption is larger than the effect of an increased variable renewable energy production in overseas countries. This is an interesting finding, especially considering that the increase in variable renewable energy production was five-fold compared to the increase in consumption. A likely reason for this is the bottlenecks introduced by the system's overseas cable connections. This is a known reason for the price difference between zones, which we also have taken into account in our modeling approach. Therefore, our analysis indicates that the capacities of the connections should be expanded along with increasing variable renewable production in overseas countries if the goal is to reduce the spot price level of electricity in Norway.   

## Weakness of the study 
This study makes several assumptions, methodological simplifications and omits certain aspects that could significantly influence the accuracy and validity of its findings. A key limitation is the assumption in the model that the explanatory power of the variables is used to model future prices, while disregarding other drivers such as fuel prices, temperature and other macroeconomic factors. The way in which prices are implicitly determined in the day-ahead spot market is not accurately reflected in the model either. Aggregating daily average prices overlooks the intra-day volatility crucial in power markets, where prices can swing dramatically within hours due to fluctuating demand and supply conditions. This simplification might fail to capture much of the dynamics in the electricity market, particularly under scenarios of high renewable penetration where variability intensifies. Additionally, the study excludes interconnectors to Sweden and Finland, and fail to account for their influence on Norwegian electricity prices, potentially skewing the results.  

Our assumption of a linear increase in consumption and variable renewable energy production does not adequately reflect potential nonlinear impacts of policy changes, economic shifts, or technological advancements. This approach may oversimplify the complex interplay of factors that drive electricity markets, such as regulatory changes, carbon pricing, and breakthroughs in energy storage or renewable technologies. 

Moreover, the analysis does not sufficiently address the potential for negative pricing, a phenomenon that occurs when there is excess generation, especially from renewables. Understanding the conditions under which negative prices occur is important, as they carry significant economic implications for market participants.

## Bibliography: 

European Commission. (2024). EU wind energy. Source: https://energy.ec.europa.eu/topics/renewable-energy/eu-wind-energy_en 
Gabrielli, P., Wüthrich, M., Blume, S., & Sansavini, G. (2022). Data-driven modeling for long-term electricity price forecasting. Energy. 
Cretì, A., & Fontini, F. (2019). Economics of Electricity Markets, Competition and Rules. Cambridge University Press. 
SSB. (2023). Rekordhøy strømpris i 2022 dempet av strømstøtte. Source: https://www.ssb.no/energi-og-industri/energi/statistikk/elektrisitetspriser/artikler/rekordhoy-strompris-i-2022--dempet-av-stromstotte 
SSB. (2024). Elektrisitet. Source: 
https://www.ssb.no/energi-og-industri/energi/statistikk/elektrisitet 
Gjerland & Gjerde. (2020). Wind Power Production and Electricity. An empirical study of the effect of increased wind power production on electricity price volatility in Norway. 
NHH. 
Energifaktanorge. (2024). Kraftmarkedet. Source: https://energifaktanorge.no/norsk-energiforsyning/kraftmarkedet/ 
Wind Europe. (2024). Rebound in wind energy financing in 2023 shows that the right policies attract investors. Source: https://windeurope.org/newsroom/press-releases/rebound-in-wind-energy-financing-in-2023-shows-that-the-right-policies-attract-investors/  
